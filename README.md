# module-go-mysql
ThingsDB module for communication with MySQL

## Building the module

To build the MySQL module, make sure Go is installed and configured.

First go to the module path and run the following command to install the module dependencies:

```
go mod tidy
```

Next, you are ready to build the module:

```
go build
```

Copy the created binary file to the ThingsDB module path.

## Configure the module

The MySQL module must be configured before it can be used.

In this example we will name the module `MySQL`. This name is arbitrary and can be anything you like. The example uses a database named `dbtest` with the
default username and password combination.

Run the following in the `@thingsdb` scope:

```
// The values MUST be changed according to your situation, this is just an example
new_module('MySQL', 'module-go-mysql', {
    dsn: "anja:pass@/test",
    conn_max_lifetime: 3,
    max_idle_conn: 10,
    max_open_conn: 1
});
```

### Arguments

Argument | Type | Description
-------- | ---- | -----------
`dsn` | `string` |
`conn_max_lifetime` | `integer` (time unit: minute; optional) | Sets the maximum amount of time a connection may be reused.
`max_idle_conn` | `integer` (optional) | Sets the maximum number of connections in the idle connection pool.
`max_open_conn` | `integer` (optional) | Sets the maximum number of open connections to the database.
`max_idle_time_conn` | `integer` (time unit: minute; optional) | Sets the maximum amount of time a connection may be idle.

## Using the module

### Query

```
future({
    module: 'MySQL',
    query: 'SELECT * FROM pet WHERE species = ?;',
    params: ['dog'],
    fetch: "Rows",
    transaction: false,
    timeout: 30
}).then(|res| res);
```

### Arguments

Argument | Type | Description
-------- | ---- | -----------
`module` | `string`| The module name.
`query` | `string` (required, except when `fetch` is `DbStats`)| Query string or template query string with `?`.
`params` | `array` (optional) | The values that need to be inserted in the query at `?`.
`fetch` | `string` (optional) | The way the result will be returned, options are: `Columns`, `Rows`, `DbStats`, `LastInsertId` or `RowsAffected`.
`transaction` | `boolean` (optional) | Indicates if the query needs to be wrapped in transaction statements or not.
`timeout` | `integer` (optional) | Provide a custom timeout in seconds (Default: 10 seconds).

### Fetch types

#### Columns

Returns a map containing the column names and corresponding column types.

#### Rows

Returns a array with maps containing the column names and corresponding values.

#### Stats

Returns the following database statistics:

* Idle: the number of idle connections.
* InUse: the number of connections currently in use.
* MaxIdleClosed: the total number of connections closed due to SetMaxIdleConns.
* MaxIdleTimeClosed: the total number of connections closed due to SetConnMaxIdleTime.
* MaxLifetimeClosed: the total number of connections closed due to SetConnMaxLifetime.
* MaxOpenConnections: maximum number of open connections to the database.
* OpenConnections: the number of established connections both in use and idle.
* WaitCount: the total number of connections waited for.
* WaitDuration: the total time blocked waiting for a new connection.

#### LastInsertId

Returns the integer generated by the database in response to a command. Typically this will be from an "auto increment" column when inserting a new row.

#### RowsAffected

Returns the number of rows affected by an update, insert, or delete.
